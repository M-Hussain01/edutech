<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2c5282;
            --accent-color: #3182ce;
            --success-color: #38a169;
            --warning-color: #d69e2e;
            --danger-color: #e53e3e;
            --light-bg: #f7fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sidebar-width: 260px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.025em;
        }
        
        .sidebar-header i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .sidebar-menu .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.875rem 1.5rem;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .sidebar-menu .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-color);
            color: white;
        }
        
        .sidebar-menu .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left-color: var(--accent-color);
            color: white;
            font-weight: 600;
        }
        
        .sidebar-menu .nav-link i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .download-section {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .download-all-btn {
            width: 100%;
            padding: 0.875rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .download-all-btn:hover {
            background-color: #2c5282;
            transform: translateY(-2px);
        }
        
        .download-all-btn i {
            margin-right: 0.5rem;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        /* Top Bar */
        .top-bar {
            background-color: var(--card-bg);
            padding: 1.25rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .top-bar h2 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
        }
        
        .admin-info span {
            margin-right: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .admin-info img {
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
            background-color: var(--card-bg);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Dashboard Cards */
        .dashboard-card {
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--card-bg) 0%, #f8fafc 100%);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-color);
        }
        
        .dashboard-card i {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        
        .dashboard-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .dashboard-card p {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Tables */
        .table {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
        }
        
        .table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        .table tbody tr:hover {
            background-color: rgba(49, 130, 206, 0.05);
        }
        
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        /* Buttons */
        .btn {
            border-radius: 0.375rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            border: none;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2c5282;
            color: white;
        }
        
        .btn-outline-primary {
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-light {
            background-color: var(--light-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-light:hover {
            background-color: #edf2f7;
            color: var(--text-primary);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #b7791f;
            color: white;
        }
        
        .btn-outline-danger {
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            background-color: transparent;
        }
        
        .btn-outline-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-outline-success {
            color: var(--success-color);
            border: 1px solid var(--success-color);
            background-color: transparent;
        }
        
        .btn-outline-success:hover {
            background-color: var(--success-color);
            color: white;
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .input-group-text {
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        /* Status Badges */
        .status-paid {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .status-unpaid {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        /* Progress Bar */
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: var(--light-bg);
        }
        
        .progress-bar {
            border-radius: 4px;
        }
        
        /* Fee Summary Stats */
        .fee-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .fee-stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .fee-stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .fee-stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .fee-stat-card.paid {
            border-left: 4px solid var(--success-color);
        }
        
        .fee-stat-card.unpaid {
            border-left: 4px solid var(--danger-color);
        }
        
        .fee-stat-card.total {
            border-left: 4px solid var(--accent-color);
        }
        
        /* Login Container */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            background: var(--card-bg);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header i {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        
        .login-header h2 {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        /* Footer */
        .footer {
            background-color: var(--primary-color);
            color: rgba(255, 255, 255, 0.8);
            padding: 2rem 0;
            margin-top: 3rem;
            margin-left: var(--sidebar-width);
        }
        
        .footer h5 {
            color: white;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            font-weight: 500;
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            z-index: 1000;
            display: none;
            font-weight: 500;
        }
        
        .connection-status.connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.625rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Modal */
        .modal-content {
            border: none;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        
        /* Confirmation Modal */
        .confirm-modal .modal-body {
            text-align: center;
            padding: 2rem;
        }
        
        .confirm-modal .modal-body i {
            font-size: 3rem;
            color: var(--warning-color);
            margin-bottom: 1rem;
        }
        
        .confirm-modal .modal-body h4 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .confirm-modal .modal-body p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }
        
        /* Download Options Modal */
        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .download-option {
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .download-option:hover {
            border-color: var(--accent-color);
            background-color: rgba(49, 130, 206, 0.05);
        }
        
        .download-option i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .download-option h5 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .download-option p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .footer {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .dashboard-card {
                margin-bottom: 1rem;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .top-bar h2 {
                margin-bottom: 1rem;
            }
            
            .fee-summary {
                grid-template-columns: 1fr;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <div class="login-container card">
            <div class="login-header">
                <i class="bi bi-mortarboard-fill"></i>
                <h2>EduTech Management System</h2>
                <p class="text-muted">Admin Login</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Admin Username</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <input type="text" class="form-control" id="username" placeholder="Enter admin username" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Admin Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input type="password" class="form-control" id="password" placeholder="Enter admin password" required>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
                <div class="loading-spinner" id="loginSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Signing in...</p>
                </div>
                <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearDataBtn">
                        <i class="bi bi-arrow-clockwise"></i> Clear Login Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Menu Toggle Button for Mobile -->
        <button class="menu-toggle" id="menuToggle">
            <i class="bi bi-list"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-mortarboard-fill"></i>
                <h3>EduTech</h3>
            </div>
            <div class="sidebar-menu">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" data-section="students">
                        <i class="bi bi-people-fill"></i> Students
                    </a>
                    <a class="nav-link" href="#" data-section="courses">
                        <i class="bi bi-book-fill"></i> Courses
                    </a>
                    <a class="nav-link" href="#" data-section="fees">
                        <i class="bi bi-cash-stack"></i> Fees
                    </a>
                    <a class="nav-link" href="#" data-section="attendance">
                        <i class="bi bi-calendar-check-fill"></i> Attendance
                    </a>
                    <a class="nav-link" href="#" id="exportDataBtn">
                        <i class="bi bi-download"></i> Export Data
                    </a>
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </nav>
            </div>
            <div class="download-section">
                <button class="download-all-btn" id="quickDownloadBtn">
                    <i class="bi bi-download"></i> Download All Data
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="admin-info">
                    <span>Welcome, <strong id="adminName">Admin</strong></span>
                    <img src="https://picsum.photos/seed/admin/40/40.jpg" alt="Admin" class="rounded-circle">
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-card">
                            <i class="bi bi-people-fill"></i>
                            <h3 id="totalStudents">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-card">
                            <i class="bi bi-book-fill"></i>
                            <h3 id="totalCourses">0</h3>
                            <p>Total Courses</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-card">
                            <i class="bi bi-cash-stack"></i>
                            <h3 id="totalFees">PKR 0</h3>
                            <p>Total Fees</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-card">
                            <i class="bi bi-calendar-check-fill"></i>
                            <h3 id="attendanceRate">0%</h3>
                            <p>Attendance Rate</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Recent Students</div>
                            <div class="card-body">
                                <ul id="recentStudents" class="list-group list-group-flush">
                                    <!-- Recent students will be added here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Fee Status</div>
                            <div class="card-body">
                                <div class="fee-summary">
                                    <div class="fee-stat-card paid">
                                        <div class="stat-value" id="paidFeesCount">0</div>
                                        <div class="stat-label">Paid Fees</div>
                                    </div>
                                    <div class="fee-stat-card unpaid">
                                        <div class="stat-value" id="unpaidFeesCount">0</div>
                                        <div class="stat-label">Unpaid Fees</div>
                                    </div>
                                    <div class="fee-stat-card total">
                                        <div class="stat-value" id="totalFeesCount">0</div>
                                        <div class="stat-label">Total Fees</div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Paid</th>
                                                <th>Unpaid</th>
                                                <th>Collection Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="feeStatusTable">
                                            <!-- Fee status will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="studentsSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Students Management</h5>
                        <div>
                            <button class="btn btn-primary me-2" id="downloadStudentsBtn">
                                <i class="bi bi-download"></i> Download CSV
                            </button>
                            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                                <i class="bi bi-plus-circle"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Roll No</th>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Course</th>
                                        <th>Fees (PKR)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Students will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses Section -->
            <div id="coursesSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Courses Management</h5>
                        <div>
                            <button class="btn btn-primary me-2" id="downloadCoursesBtn">
                                <i class="bi bi-download"></i> Download CSV
                            </button>
                            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                                <i class="bi bi-plus-circle"></i> Add Course
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Course Name</th>
                                        <th>Students Enrolled</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coursesTableBody">
                                    <!-- Courses will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fees Section -->
            <div id="feesSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Fees Management</h5>
                        <div class="d-flex">
                            <select id="monthSelect" class="form-select me-2">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="yearSelect" class="form-select me-2">
                                <!-- Years will be populated dynamically -->
                            </select>
                            <button class="btn btn-primary" id="downloadFeesBtn">
                                <i class="bi bi-download"></i> Download CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Roll No</th>
                                        <th>ID</th>
                                        <th>Student Name</th>
                                        <th>Course</th>
                                        <th>Fee Amount (PKR)</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feesTableBody">
                                    <!-- Fees will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Attendance Management</h5>
                        <div class="d-flex">
                            <input type="date" id="attendanceDate" class="form-control me-2">
                            <button id="markAttendanceBtn" class="btn btn-light me-2">
                                <i class="bi bi-check2-square"></i> Mark Attendance
                            </button>
                            <button id="deleteAttendanceBtn" class="btn btn-outline-danger me-2">
                                <i class="bi bi-trash"></i> Delete 3 Months
                            </button>
                            <button class="btn btn-primary" id="downloadAttendanceBtn">
                                <i class="bi bi-download"></i> Download CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Roll No</th>
                                        <th>ID</th>
                                        <th>Student Name</th>
                                        <th>Course</th>
                                        <th>Attendance Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Attendance will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h5>EduTech Management System</h5>
                        <p>Comprehensive solution for educational institutions</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p>&copy; 2023 EduTech Management. All rights reserved.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentContact" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="studentContact" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentFees" class="form-label">Fees (PKR)</label>
                            <input type="number" class="form-control" id="studentFees" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentCourse" class="form-label">Course</label>
                            <select class="form-select" id="studentCourse" required>
                                <option value="">Select Course</option>
                                <!-- Courses will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Add Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label for="editStudentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentContact" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="editStudentContact" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentFees" class="form-label">Fees (PKR)</label>
                            <input type="number" class="form-control" id="editStudentFees" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentCourse" class="form-label">Course</label>
                            <select class="form-select" id="editStudentCourse" required>
                                <option value="">Select Course</option>
                                <!-- Courses will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Update Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="addCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm">
                        <div class="mb-3">
                            <label for="courseName" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="courseName" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Add Course</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div class="modal fade" id="editCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCourseForm">
                        <input type="hidden" id="editCourseId">
                        <div class="mb-3">
                            <label for="editCourseName" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="editCourseName" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Update Course</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Enroll Student Modal -->
    <div class="modal fade" id="enrollStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll Student in Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="enrollStudentForm">
                        <input type="hidden" id="enrollCourseId">
                        <div class="mb-3">
                            <label for="enrollStudentName" class="form-label">Student Name</label>
                            <select class="form-select" id="enrollStudentName" required>
                                <option value="">Select Student</option>
                                <!-- Students will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Enroll Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark Attendance Modal -->
    <div class="modal fade" id="markAttendanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Attendance for <span id="attendanceDateDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>ID</th>
                                    <th>Student Name</th>
                                    <th>Course</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBodyModal">
                                <!-- Students will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="saveAttendanceBtn">Save Attendance</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div class="modal fade" id="exportDataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="download-options">
                        <div class="download-option" onclick="downloadAllData()">
                            <i class="bi bi-download"></i>
                            <h5>Download All Data</h5>
                            <p>Export all data in a single file</p>
                        </div>
                        <div class="download-option" onclick="downloadStudentsData()">
                            <i class="bi bi-people-fill"></i>
                            <h5>Students Data</h5>
                            <p>Export students information</p>
                        </div>
                        <div class="download-option" onclick="downloadCoursesData()">
                            <i class="bi bi-book-fill"></i>
                            <h5>Courses Data</h5>
                            <p>Export courses information</p>
                        </div>
                        <div class="download-option" onclick="downloadFeesData()">
                            <i class="bi bi-cash-stack"></i>
                            <h5>Fees Data</h5>
                            <p>Export fees information</p>
                        </div>
                        <div class="download-option" onclick="downloadAttendanceData()">
                            <i class="bi bi-calendar-check-fill"></i>
                            <h5>Attendance Data</h5>
                            <p>Export attendance information</p>
                        </div>
                        <div class="download-option" onclick="downloadSummaryReport()">
                            <i class="bi bi-file-earmark-text"></i>
                            <h5>Summary Report</h5>
                            <p>Export summary statistics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade confirm-modal" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <h4 id="confirmTitle">Confirm Action</h4>
                    <p id="confirmMessage">Are you sure you want to perform this action?</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmButton">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, update, remove, onValue, query as rtdbQuery, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_jAuvdnqVA-g4JzL90fukKGGN_U1mMAI",
            authDomain: "edutech-ead49.firebaseapp.com",
            databaseURL: "https://edutech-ead49-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "edutech-ead49",
            storageBucket: "edutech-ead49.firebasestorage.app",
            messagingSenderId: "503549426705",
            appId: "1:503549426705:web:c9130b6202d5f9b31185b0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Realtime Database
        let database;
        let databaseInitialized = false;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const quickDownloadBtn = document.getElementById('quickDownloadBtn');
        const navLinks = document.querySelectorAll('.sidebar-menu .nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const notification = document.getElementById('notification');
        const loginSpinner = document.getElementById('loginSpinner');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const pageTitle = document.getElementById('pageTitle');
        const adminName = document.getElementById('adminName');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Download buttons
        const downloadStudentsBtn = document.getElementById('downloadStudentsBtn');
        const downloadCoursesBtn = document.getElementById('downloadCoursesBtn');
        const downloadFeesBtn = document.getElementById('downloadFeesBtn');
        const downloadAttendanceBtn = document.getElementById('downloadAttendanceBtn');
        
        // Export modal buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const exportStudentsDataBtn = document.getElementById('exportStudentsDataBtn');
        const exportCoursesDataBtn = document.getElementById('exportCoursesDataBtn');
        const exportFeesDataBtn = document.getElementById('exportFeesDataBtn');
        const exportAttendanceDataBtn = document.getElementById('exportAttendanceDataBtn');
        
        // Confirmation modal elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmButton = document.getElementById('confirmButton');
        
        // Cache for data
        let coursesCache = [];
        let studentsCache = [];
        let nextRollNumber = 1; // For generating roll numbers
        
        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Clear login data button
        clearDataBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            showNotification('Login data cleared successfully!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        });
        
        // Initialize Realtime Database
        async function initializeDatabase() {
            try {
                database = getDatabase(app);
                console.log("Realtime Database initialized successfully");
                showConnectionStatus('Connected to database', 'connected');
                databaseInitialized = true;
                return true;
            } catch (error) {
                console.error("Error initializing Realtime Database:", error);
                showConnectionStatus('Database connection failed: ' + error.message, 'disconnected');
                return false;
            }
        }
        
        // Show connection status
        function showConnectionStatus(message, type) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${type}`;
            connectionStatus.style.display = 'block';
            
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 5000);
        }
        
        // Check if user is already logged in
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize Database
            const databaseInitialized = await initializeDatabase();
            
            if (!databaseInitialized) {
                showNotification('Failed to connect to database. Please check your connection.', 'error');
                return;
            }
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const username = localStorage.getItem('username');
            
            // Only show dashboard if both isLoggedIn is true and username is valid
            if (isLoggedIn === 'true' && username === 'shariq') {
                loginScreen.style.display = 'none';
                dashboard.style.display = 'block';
                adminName.textContent = username;
                loadDashboard();
            } else {
                // Clear any invalid login data
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                loginScreen.style.display = 'block';
                dashboard.style.display = 'none';
            }
            
            // Set current date for attendance
            const today = new Date();
            document.getElementById('attendanceDate').value = today.toISOString().split('T')[0];
        });
        
        // Login functionality
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Show loading spinner
            loginSpinner.style.display = 'block';
            
            // Fixed admin credentials
            const adminUsername = "shariq";
            const adminPassword = "shariq123";
            
            // Simple validation
            setTimeout(() => {
                if (username === adminUsername && password === adminPassword) {
                    // Set login state in localStorage
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', username);
                    
                    // Show dashboard
                    loginScreen.style.display = 'none';
                    dashboard.style.display = 'block';
                    adminName.textContent = username;
                    
                    // Show success message
                    showNotification('Login successful!', 'success');
                    loginSpinner.style.display = 'none';
                    
                    // Load dashboard data
                    loadDashboard();
                } else {
                    // Show error message
                    showNotification('Invalid username or password!', 'error');
                    loginSpinner.style.display = 'none';
                }
            }, 500); // Reduced delay for faster response
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            // Clear login state from localStorage
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            
            // Show login screen
            loginScreen.style.display = 'block';
            dashboard.style.display = 'none';
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Show success message
            showNotification('Logged out successfully!', 'success');
        });
        
        // Quick download functionality
        quickDownloadBtn.addEventListener('click', () => {
            downloadAllData();
        });
        
        // Export data functionality
        exportDataBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('exportDataModal'));
            modal.show();
        });
        
        // Navigation functionality
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                
                if (section) {
                    // Update active nav link
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show selected section
                    contentSections.forEach(s => s.style.display = 'none');
                    document.getElementById(`${section}Section`).style.display = 'block';
                    
                    // Update page title
                    pageTitle.textContent = link.textContent.trim();
                    
                    // Load section data
                    if (section === 'dashboard') {
                        loadDashboard();
                    } else if (section === 'students') {
                        loadStudents();
                    } else if (section === 'courses') {
                        loadCourses();
                    } else if (section === 'fees') {
                        loadFees();
                    } else if (section === 'attendance') {
                        loadAttendance();
                    }
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                }
            });
        });
        
        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Show loading overlay
        function showLoading(show = true) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        // Generate next roll number
        async function getNextRollNumber() {
            try {
                const studentsRef = ref(database, 'students');
                const snapshot = await get(studentsRef);
                
                if (snapshot.exists()) {
                    const students = snapshot.val();
                    let maxRollNumber = 0;
                    
                    Object.values(students).forEach(student => {
                        if (student.rollNumber && student.rollNumber > maxRollNumber) {
                            maxRollNumber = student.rollNumber;
                        }
                    });
                    
                    return maxRollNumber + 1;
                } else {
                    return 1;
                }
            } catch (error) {
                console.error("Error getting next roll number:", error);
                return nextRollNumber++;
            }
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log("Loading dashboard data...");
                
                // Get total students
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                const students = studentsSnapshot.val() || {};
                const studentCount = Object.keys(students).length;
                document.getElementById('totalStudents').textContent = studentCount;
                
                // Get total courses
                const coursesRef = ref(database, 'courses');
                const coursesSnapshot = await get(coursesRef);
                const courses = coursesSnapshot.val() || {};
                const courseCount = Object.keys(courses).length;
                document.getElementById('totalCourses').textContent = courseCount;
                
                // Get total fees
                let totalFees = 0;
                Object.values(students).forEach(student => {
                    totalFees += parseInt(student.fees) || 0;
                });
                document.getElementById('totalFees').textContent = `PKR ${totalFees.toLocaleString()}`;
                
                // Get attendance rate (simplified calculation)
                const attendanceRef = ref(database, 'attendance');
                const attendanceSnapshot = await get(attendanceRef);
                const attendance = attendanceSnapshot.val() || {};
                
                let totalRecords = 0;
                let presentRecords = 0;
                
                Object.values(attendance).forEach(record => {
                    if (record.status === 'present') {
                        presentRecords++;
                    }
                    totalRecords++;
                });
                
                const attendanceRate = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                
                // Get recent students
                const recentStudentsList = document.getElementById('recentStudents');
                recentStudentsList.innerHTML = '';
                
                // Convert to array and sort by createdAt
                const studentsArray = Object.values(students);
                studentsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                studentsArray.slice(0, 5).forEach(student => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <strong>Roll ${student.rollNumber || 'N/A'}: ${student.name}</strong>
                            <div class="text-muted small">${student.course}</div>
                        </div>
                        <span class="badge bg-primary rounded-pill">PKR ${student.fees}</span>
                    `;
                    recentStudentsList.appendChild(li);
                });
                
                // Load fee status data
                await loadFeeStatusData();
                
                console.log("Dashboard data loaded successfully");
            } catch (error) {
                console.error("Error loading dashboard:", error);
                showNotification('Error loading dashboard: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Load fee status data for dashboard
        async function loadFeeStatusData() {
            try {
                const feesRef = ref(database, 'fees');
                const feesSnapshot = await get(feesRef);
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                let paidCount = 0;
                let unpaidCount = 0;
                let totalCount = 0;
                
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const monthlyData = {};
                
                // Initialize monthly data
                for (let i = 0; i < 12; i++) {
                    monthlyData[i] = { paid: 0, unpaid: 0 };
                }
                
                if (feesSnapshot.exists()) {
                    const fees = feesSnapshot.val();
                    const students = studentsSnapshot.val() || {};
                    
                    Object.values(fees).forEach(fee => {
                        totalCount++;
                        if (fee.status === 'paid') {
                            paidCount++;
                            monthlyData[fee.month].paid++;
                        } else {
                            unpaidCount++;
                            monthlyData[fee.month].unpaid++;
                        }
                    });
                }
                
                // Update summary cards
                document.getElementById('paidFeesCount').textContent = paidCount;
                document.getElementById('unpaidFeesCount').textContent = unpaidCount;
                document.getElementById('totalFeesCount').textContent = totalCount;
                
                // Update monthly table
                const feeStatusTable = document.getElementById('feeStatusTable');
                feeStatusTable.innerHTML = '';
                
                const currentMonth = new Date().getMonth();
                
                // Show last 6 months
                for (let i = 5; i >= 0; i--) {
                    const monthIndex = (currentMonth - i + 12) % 12;
                    const monthData = monthlyData[monthIndex];
                    const total = monthData.paid + monthData.unpaid;
                    const rate = total > 0 ? Math.round((monthData.paid / total) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${monthNames[monthIndex]}</td>
                        <td>${monthData.paid}</td>
                        <td>${monthData.unpaid}</td>
                        <td>${rate}%</td>
                    `;
                    feeStatusTable.appendChild(row);
                }
            } catch (error) {
                console.error("Error loading fee status data:", error);
            }
        }
        
        // Load courses and cache them
        async function loadAndCacheCourses() {
            try {
                const coursesRef = ref(database, 'courses');
                const snapshot = await get(coursesRef);
                
                if (snapshot.exists()) {
                    coursesCache = Object.values(snapshot.val());
                    return coursesCache;
                } else {
                    coursesCache = [];
                    return [];
                }
            } catch (error) {
                console.error("Error loading courses:", error);
                showNotification('Error loading courses: ' + error.message, 'error');
                return [];
            }
        }
        
        // Load students and cache them
        async function loadAndCacheStudents() {
            try {
                const studentsRef = ref(database, 'students');
                const snapshot = await get(studentsRef);
                
                if (snapshot.exists()) {
                    studentsCache = Object.values(snapshot.val());
                    return studentsCache;
                } else {
                    studentsCache = [];
                    return [];
                }
            } catch (error) {
                console.error("Error loading students:", error);
                showNotification('Error loading students: ' + error.message, 'error');
                return [];
            }
        }
        
        // Load students
        async function loadStudents() {
            try {
                console.log("Loading students...");
                
                const studentsTableBody = document.getElementById('studentsTableBody');
                studentsTableBody.innerHTML = '';
                
                const studentsRef = ref(database, 'students');
                const snapshot = await get(studentsRef);
                
                if (snapshot.exists()) {
                    const students = snapshot.val();
                    Object.keys(students).forEach(key => {
                        const student = students[key];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.rollNumber || 'N/A'}</td>
                            <td>${key}</td>
                            <td>${student.name}</td>
                            <td>${student.contact}</td>
                            <td>${student.course}</td>
                            <td>PKR ${student.fees}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editStudent('${key}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${key}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        studentsTableBody.appendChild(row);
                    });
                    console.log("Students loaded successfully");
                } else {
                    console.log("No students found");
                }
                
                // Populate course dropdowns
                populateCourseDropdowns();
            } catch (error) {
                console.error("Error loading students:", error);
                showNotification('Error loading students: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Add student
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Adding student...");
                
                const name = document.getElementById('studentName').value;
                const contact = document.getElementById('studentContact').value;
                const fees = document.getElementById('studentFees').value;
                const course = document.getElementById('studentCourse').value;
                
                console.log("Student data:", { name, contact, fees, course });
                
                // Generate a new key for the student
                const newStudentRef = push(ref(database, 'students'));
                
                // Get next roll number
                const rollNumber = await getNextRollNumber();
                
                // Set the student data
                await set(newStudentRef, {
                    name,
                    contact,
                    fees,
                    course,
                    rollNumber,
                    createdAt: new Date().toISOString()
                });
                
                console.log("Student added with ID:", newStudentRef.key);
                
                showNotification('Student added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                document.getElementById('addStudentForm').reset();
                loadStudents();
            } catch (error) {
                console.error("Error adding student:", error);
                showNotification('Error adding student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Edit student
        window.editStudent = async function(id) {
            try {
                console.log("Editing student:", id);
                
                const studentRef = ref(database, 'students/' + id);
                const snapshot = await get(studentRef);
                
                if (snapshot.exists()) {
                    const student = snapshot.val();
                    
                    console.log("Student data:", student);
                    
                    document.getElementById('editStudentId').value = id;
                    document.getElementById('editStudentName').value = student.name;
                    document.getElementById('editStudentContact').value = student.contact;
                    document.getElementById('editStudentFees').value = student.fees;
                    document.getElementById('editStudentCourse').value = student.course;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                    modal.show();
                } else {
                    console.error("Student not found");
                    showNotification('Student not found', 'error');
                }
            } catch (error) {
                console.error("Error loading student data:", error);
                showNotification('Error loading student data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Update student
        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Updating student...");
                
                const id = document.getElementById('editStudentId').value;
                const name = document.getElementById('editStudentName').value;
                const contact = document.getElementById('editStudentContact').value;
                const fees = document.getElementById('editStudentFees').value;
                const course = document.getElementById('editStudentCourse').value;
                
                console.log("Updated student data:", { id, name, contact, fees, course });
                
                await update(ref(database, 'students/' + id), {
                    name,
                    contact,
                    fees,
                    course
                });
                
                console.log("Student updated successfully");
                
                showNotification('Student updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
            } catch (error) {
                console.error("Error updating student:", error);
                showNotification('Error updating student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete student
        window.deleteStudent = async function(id) {
            try {
                console.log("Deleting student:", id);
                
                // Show confirmation modal
                confirmTitle.textContent = "Delete Student";
                confirmMessage.textContent = "Are you sure you want to delete this student? This action cannot be undone.";
                
                confirmButton.onclick = async function() {
                    try {
                        await remove(ref(database, 'students/' + id));
                        
                        console.log("Student deleted successfully");
                        
                        showNotification('Student deleted successfully!', 'success');
                        loadStudents();
                        
                        // Hide confirmation modal
                        bootstrap.Modal.getInstance(confirmModal).hide();
                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showNotification('Error deleting student: ' + error.message, 'error');
                        showConnectionStatus('Database error: ' + error.message, 'disconnected');
                    }
                };
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(confirmModal);
                modal.show();
            } catch (error) {
                console.error("Error preparing student deletion:", error);
                showNotification('Error preparing deletion: ' + error.message, 'error');
            }
        };
        
        // Load courses
        async function loadCourses() {
            try {
                console.log("Loading courses...");
                
                const coursesTableBody = document.getElementById('coursesTableBody');
                coursesTableBody.innerHTML = '';
                
                const coursesRef = ref(database, 'courses');
                const snapshot = await get(coursesRef);
                
                if (snapshot.exists()) {
                    const courses = snapshot.val();
                    
                    // Get students count for each course
                    const studentsRef = ref(database, 'students');
                    const studentsSnapshot = await get(studentsRef);
                    const students = studentsSnapshot.val() || {};
                    
                    Object.keys(courses).forEach(key => {
                        const course = courses[key];
                        
                        // Count enrolled students
                        let enrolledCount = 0;
                        Object.keys(students).forEach(studentId => {
                            if (students[studentId].course === course.name) {
                                enrolledCount++;
                            }
                        });
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${key}</td>
                            <td>${course.name}</td>
                            <td>${enrolledCount}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editCourse('${key}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteCourse('${key}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="enrollStudent('${key}')">
                                    <i class="bi bi-person-plus"></i> Enroll
                                </button>
                            </td>
                        `;
                        coursesTableBody.appendChild(row);
                    });
                    
                    console.log("Courses loaded successfully");
                } else {
                    console.log("No courses found");
                }
            } catch (error) {
                console.error("Error loading courses:", error);
                showNotification('Error loading courses: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Add course
        document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Adding course...");
                
                const name = document.getElementById('courseName').value;
                
                console.log("Course data:", { name });
                
                const newCourseRef = push(ref(database, 'courses'));
                await set(newCourseRef, {
                    name,
                    createdAt: new Date().toISOString()
                });
                
                console.log("Course added with ID:", newCourseRef.key);
                
                showNotification('Course added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
                document.getElementById('addCourseForm').reset();
                
                // Update courses cache
                await loadAndCacheCourses();
                
                // Refresh course dropdowns
                populateCourseDropdowns();
                
                // Reload courses section
                loadCourses();
            } catch (error) {
                console.error("Error adding course:", error);
                showNotification('Error adding course: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Edit course
        window.editCourse = async function(id) {
            try {
                console.log("Editing course:", id);
                
                const courseRef = ref(database, 'courses/' + id);
                const snapshot = await get(courseRef);
                
                if (snapshot.exists()) {
                    const course = snapshot.val();
                    
                    console.log("Course data:", course);
                    
                    document.getElementById('editCourseId').value = id;
                    document.getElementById('editCourseName').value = course.name;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editCourseModal'));
                    modal.show();
                } else {
                    console.error("Course not found");
                    showNotification('Course not found', 'error');
                }
            } catch (error) {
                console.error("Error loading course data:", error);
                showNotification('Error loading course data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Update course
        document.getElementById('editCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Updating course...");
                
                const id = document.getElementById('editCourseId').value;
                const name = document.getElementById('editCourseName').value;
                
                console.log("Updated course data:", { id, name });
                
                await update(ref(database, 'courses/' + id), {
                    name
                });
                
                console.log("Course updated successfully");
                
                showNotification('Course updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
                
                // Update courses cache
                await loadAndCacheCourses();
                
                // Refresh course dropdowns
                populateCourseDropdowns();
                
                // Reload courses section
                loadCourses();
            } catch (error) {
                console.error("Error updating course:", error);
                showNotification('Error updating course: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete course
        window.deleteCourse = async function(id) {
            try {
                console.log("Deleting course:", id);
                
                // Show confirmation modal
                confirmTitle.textContent = "Delete Course";
                confirmMessage.textContent = "Are you sure you want to delete this course? This action cannot be undone.";
                
                confirmButton.onclick = async function() {
                    try {
                        await remove(ref(database, 'courses/' + id));
                        
                        console.log("Course deleted successfully");
                        
                        showNotification('Course deleted successfully!', 'success');
                        
                        // Update courses cache
                        await loadAndCacheCourses();
                        
                        // Refresh course dropdowns
                        populateCourseDropdowns();
                        
                        // Reload courses section
                        loadCourses();
                        
                        // Hide confirmation modal
                        bootstrap.Modal.getInstance(confirmModal).hide();
                    } catch (error) {
                        console.error("Error deleting course:", error);
                        showNotification('Error deleting course: ' + error.message, 'error');
                        showConnectionStatus('Database error: ' + error.message, 'disconnected');
                    }
                };
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(confirmModal);
                modal.show();
            } catch (error) {
                console.error("Error preparing course deletion:", error);
                showNotification('Error preparing deletion: ' + error.message, 'error');
            }
        };
        
        // Enroll student in course
        window.enrollStudent = async function(courseId) {
            try {
                console.log("Enrolling student in course:", courseId);
                
                document.getElementById('enrollCourseId').value = courseId;
                
                // Populate student dropdown
                const studentDropdown = document.getElementById('enrollStudentName');
                studentDropdown.innerHTML = '<option value="">Select Student</option>';
                
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    Object.keys(students).forEach(key => {
                        const student = students[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `Roll ${student.rollNumber || 'N/A'}: ${student.name}`;
                        studentDropdown.appendChild(option);
                    });
                }
                
                const modal = new bootstrap.Modal(document.getElementById('enrollStudentModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading students for enrollment:", error);
                showNotification('Error loading students: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Process enrollment
        document.getElementById('enrollStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Processing enrollment...");
                
                const courseId = document.getElementById('enrollCourseId').value;
                const studentId = document.getElementById('enrollStudentName').value;
                
                console.log("Enrollment data:", { courseId, studentId });
                
                // Get course name
                const courseRef = ref(database, 'courses/' + courseId);
                const courseSnapshot = await get(courseRef);
                const courseName = courseSnapshot.val().name;
                
                // Update student's course
                await update(ref(database, 'students/' + studentId), {
                    course: courseName
                });
                
                console.log("Student enrolled successfully");
                
                showNotification('Student enrolled successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal')).hide();
                loadCourses();
                loadStudents();
            } catch (error) {
                console.error("Error enrolling student:", error);
                showNotification('Error enrolling student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Load fees
        function loadFees() {
            // Set current month and year
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth();
            
            // Populate year dropdown
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            const currentYear = now.getFullYear();
            
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Load fees data
            loadFeesData();
        }
        
        // Load fees data based on selected month and year
        async function loadFeesData() {
            try {
                console.log("Loading fees data...");
                
                const month = document.getElementById('monthSelect').value;
                const year = document.getElementById('yearSelect').value;
                
                const feesTableBody = document.getElementById('feesTableBody');
                feesTableBody.innerHTML = '';
                
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    console.log("Found", Object.keys(students).length, "students for fees");
                    
                    Object.keys(students).forEach(studentId => {
                        const student = students[studentId];
                        
                        // Check if fee record exists for this month/year
                        const feesRef = ref(database, 'fees');
                        const feesSnapshot = get(feesRef);
                        
                        feesSnapshot.then(feesData => {
                            let status = 'unpaid';
                            let feeId = '';
                            
                            if (feesData.exists()) {
                                const fees = feesData.val();
                                Object.keys(fees).forEach(key => {
                                    const fee = fees[key];
                                    if (fee.studentId === studentId && 
                                        fee.month === parseInt(month) && 
                                        fee.year === parseInt(year)) {
                                        status = fee.status;
                                        feeId = key;
                                    }
                                });
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${student.rollNumber || 'N/A'}</td>
                                <td>${studentId}</td>
                                <td>${student.name}</td>
                                <td>${student.course}</td>
                                <td>PKR ${student.fees}</td>
                                <td>
                                    <span class="${status === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                        ${status === 'paid' ? 'Paid' : 'Unpaid'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm ${status === 'paid' ? 'btn-outline-warning' : 'btn-outline-success'}" 
                                            onclick="toggleFeeStatus('${studentId}', '${month}', '${year}', '${status}', '${feeId}')">
                                        ${status === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}
                                    </button>
                                </td>
                            `;
                            feesTableBody.appendChild(row);
                        });
                    });
                }
                
                console.log("Fees data loaded successfully");
            } catch (error) {
                console.error("Error loading fees data:", error);
                showNotification('Error loading fees: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Toggle fee status
        window.toggleFeeStatus = async function(studentId, month, year, currentStatus, feeId) {
            try {
                console.log("Toggling fee status...");
                
                const newStatus = currentStatus === 'paid' ? 'unpaid' : 'paid';
                
                if (feeId) {
                    // Update existing fee record
                    await update(ref(database, 'fees/' + feeId), {
                        status: newStatus
                    });
                } else {
                    // Create new fee record
                    const newFeeRef = push(ref(database, 'fees'));
                    await set(newFeeRef, {
                        studentId,
                        month: parseInt(month),
                        year: parseInt(year),
                        status: newStatus,
                        createdAt: new Date().toISOString()
                    });
                }
                
                console.log("Fee status updated successfully");
                
                showNotification(`Fee marked as ${newStatus}!`, 'success');
                loadFeesData();
            } catch (error) {
                console.error("Error updating fee status:", error);
                showNotification('Error updating fee status: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Month/year change event listeners
        document.getElementById('monthSelect').addEventListener('change', loadFeesData);
        document.getElementById('yearSelect').addEventListener('change', loadFeesData);
        
        // Load attendance
        async function loadAttendance() {
            try {
                console.log("Loading attendance...");
                
                const attendanceTableBody = document.getElementById('attendanceTableBody');
                attendanceTableBody.innerHTML = '';
                
                // Set today's date as default
                const today = new Date();
                document.getElementById('attendanceDate').value = today.toISOString().split('T')[0];
                
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    console.log("Found", Object.keys(students).length, "students for attendance");
                    
                    Object.keys(students).forEach(studentId => {
                        const student = students[studentId];
                        
                        // Calculate attendance rate (simplified)
                        const attendanceRef = ref(database, 'attendance');
                        const attendanceSnapshot = get(attendanceRef);
                        
                        attendanceSnapshot.then(attData => {
                            let totalDays = 0;
                            let presentDays = 0;
                            
                            if (attData.exists()) {
                                const attendance = attData.val();
                                Object.keys(attendance).forEach(key => {
                                    const att = attendance[key];
                                    if (att.studentId === studentId) {
                                        totalDays++;
                                        if (att.status === 'present') {
                                            presentDays++;
                                        }
                                    }
                                });
                            }
                            
                            const attendanceRate = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${student.rollNumber || 'N/A'}</td>
                                <td>${studentId}</td>
                                <td>${student.name}</td>
                                <td>${student.course}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: ${attendanceRate}%; background-color: ${attendanceRate > 70 ? '#38a169' : attendanceRate > 40 ? '#d69e2e' : '#e53e3e'};"
                                             aria-valuenow="${attendanceRate}" aria-valuemin="0" aria-valuemax="100">
                                            ${attendanceRate}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewStudentAttendance('${studentId}')">
                                        <i class="bi bi-calendar3"></i> View
                                    </button>
                                </td>
                            `;
                            attendanceTableBody.appendChild(row);
                        });
                    });
                }
                
                console.log("Attendance loaded successfully");
            } catch (error) {
                console.error("Error loading attendance:", error);
                showNotification('Error loading attendance: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Mark attendance button
        document.getElementById('markAttendanceBtn').addEventListener('click', async () => {
            try {
                console.log("Marking attendance...");
                
                const date = document.getElementById('attendanceDate').value;
                if (!date) {
                    showNotification('Please select a date!', 'error');
                    return;
                }
                
                document.getElementById('attendanceDateDisplay').textContent = new Date(date).toLocaleDateString();
                
                // Populate attendance table
                const attendanceTableBodyModal = document.getElementById('attendanceTableBodyModal');
                attendanceTableBodyModal.innerHTML = '';
                
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    console.log("Found", Object.keys(students).length, "students for marking attendance");
                    
                    Object.keys(students).forEach(studentId => {
                        const student = students[studentId];
                        
                        // Check if attendance already exists for this date
                        const attendanceRef = ref(database, 'attendance');
                        const attendanceSnapshot = get(attendanceRef);
                        
                        attendanceSnapshot.then(attData => {
                            let status = 'absent';
                            
                            if (attData.exists()) {
                                const attendance = attData.val();
                                Object.keys(attendance).forEach(key => {
                                    const att = attendance[key];
                                    if (att.studentId === studentId && att.date === date) {
                                        status = att.status;
                                    }
                                });
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${student.rollNumber || 'N/A'}</td>
                                <td>${studentId}</td>
                                <td>${student.name}</td>
                                <td>${student.course}</td>
                                <td>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="attendance-${studentId}" 
                                               id="present-${studentId}" value="present" ${status === 'present' ? 'checked' : ''}>
                                        <label class="form-check-label" for="present-${studentId}">Present</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="attendance-${studentId}" 
                                               id="absent-${studentId}" value="absent" ${status === 'absent' ? 'checked' : ''}>
                                        <label class="form-check-label" for="absent-${studentId}">Absent</label>
                                    </div>
                                </td>
                            `;
                            attendanceTableBodyModal.appendChild(row);
                        });
                    });
                }
                
                const modal = new bootstrap.Modal(document.getElementById('markAttendanceModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading attendance data:", error);
                showNotification('Error loading attendance data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Save attendance
        document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
            try {
                console.log("Saving attendance...");
                
                const date = document.getElementById('attendanceDate').value;
                
                const studentsRef = ref(database, 'students');
                const studentsSnapshot = await get(studentsRef);
                
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    
                    Object.keys(students).forEach(studentId => {
                        const statusRadio = document.querySelector(`input[name="attendance-${studentId}"]:checked`);
                        
                        if (statusRadio) {
                            const status = statusRadio.value;
                            
                            // Check if attendance record already exists
                            const attendanceRef = ref(database, 'attendance');
                            const attendanceSnapshot = get(attendanceRef);
                            
                            attendanceSnapshot.then(attData => {
                                let recordExists = false;
                                let existingKey = '';
                                
                                if (attData.exists()) {
                                    const attendance = attData.val();
                                    Object.keys(attendance).forEach(key => {
                                        const att = attendance[key];
                                        if (att.studentId === studentId && att.date === date) {
                                            recordExists = true;
                                            existingKey = key;
                                        }
                                    });
                                }
                                
                                if (recordExists) {
                                    // Update existing record
                                    update(ref(database, 'attendance/' + existingKey), {
                                        status
                                    }).then(() => {
                                        console.log("Attendance updated for student:", studentId);
                                    }).catch(error => {
                                        console.error("Error updating attendance:", error);
                                    });
                                } else {
                                    // Create new record
                                    const newAttRef = push(ref(database, 'attendance'));
                                    set(newAttRef, {
                                        studentId,
                                        date,
                                        status,
                                        createdAt: new Date().toISOString()
                                    }).then(() => {
                                        console.log("Attendance added for student:", studentId);
                                    }).catch(error => {
                                        console.error("Error adding attendance:", error);
                                    });
                                }
                            });
                        }
                    });
                }
                
                console.log("Attendance saved successfully");
                showNotification('Attendance saved successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('markAttendanceModal')).hide();
                loadAttendance();
            } catch (error) {
                console.error("Error saving attendance:", error);
                showNotification('Error saving attendance: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete attendance data for 3 months
        document.getElementById('deleteAttendanceBtn').addEventListener('click', () => {
            // Show confirmation modal
            confirmTitle.textContent = "Delete Attendance Data";
            confirmMessage.textContent = "Are you sure you want to delete all attendance data for the last 3 months? This action cannot be undone.";
            
            confirmButton.onclick = async function() {
                try {
                    console.log("Deleting attendance data for last 3 months...");
                    
                    // Get current date
                    const currentDate = new Date();
                    
                    // Calculate date 3 months ago
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(currentDate.getMonth() - 3);
                    
                    // Get all attendance records
                    const attendanceRef = ref(database, 'attendance');
                    const attendanceSnapshot = get(attendanceRef);
                    
                    attendanceSnapshot.then(snapshot => {
                        if (snapshot.exists()) {
                            const attendance = snapshot.val();
                            let deletedCount = 0;
                            
                            Object.keys(attendance).forEach(key => {
                                const att = attendance[key];
                                const attDate = new Date(att.date);
                                
                                // Check if attendance date is within the last 3 months
                                if (attDate >= threeMonthsAgo && attDate <= currentDate) {
                                    remove(ref(database, 'attendance/' + key)).then(() => {
                                        console.log("Deleted attendance record:", key);
                                        deletedCount++;
                                    }).catch(error => {
                                        console.error("Error deleting attendance record:", error);
                                    });
                                }
                            });
                            
                            console.log("Attendance data deleted successfully");
                            showNotification(`Deleted ${deletedCount} attendance records for the last 3 months!`, 'success');
                            loadAttendance();
                        } else {
                            showNotification('No attendance data found!', 'error');
                        }
                        
                        // Hide confirmation modal
                        bootstrap.Modal.getInstance(confirmModal).hide();
                    }).catch(error => {
                        console.error("Error deleting attendance data:", error);
                        showNotification('Error deleting attendance data: ' + error.message, 'error');
                        showConnectionStatus('Database error: ' + error.message, 'disconnected');
                        bootstrap.Modal.getInstance(confirmModal).hide();
                    });
                } catch (error) {
                    console.error("Error preparing attendance deletion:", error);
                    showNotification('Error preparing deletion: ' + error.message, 'error');
                    bootstrap.Modal.getInstance(confirmModal).hide();
                }
            };
            
            // Show confirmation modal
            const modal = new bootstrap.Modal(confirmModal);
            modal.show();
        });
        
        // View student attendance (placeholder function)
        window.viewStudentAttendance = function(studentId) {
            showNotification('Student attendance view would open here', 'success');
        };
        
        // Populate course dropdowns
        async function populateCourseDropdowns() {
            try {
                console.log("Populating course dropdowns...");
                
                const studentCourseDropdown = document.getElementById('studentCourse');
                const editStudentCourseDropdown = document.getElementById('editStudentCourse');
                
                studentCourseDropdown.innerHTML = '<option value="">Select Course</option>';
                editStudentCourseDropdown.innerHTML = '<option value="">Select Course</option>';
                
                // Load courses from cache or database
                let courses = coursesCache;
                if (courses.length === 0) {
                    courses = await loadAndCacheCourses();
                }
                
                courses.forEach(course => {
                    const option1 = document.createElement('option');
                    option1.value = course.name;
                    option1.textContent = course.name;
                    studentCourseDropdown.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = course.name;
                    option2.textContent = course.name;
                    editStudentCourseDropdown.appendChild(option2);
                });
                
                console.log("Course dropdowns populated successfully");
            } catch (error) {
                console.error("Error populating course dropdowns:", error);
                showNotification('Error loading courses: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Function to create and download a ZIP file with all data
        async function downloadAllDataAsZip() {
            try {
                console.log("Downloading all data as ZIP...");
                
                // Get all data
                const studentsRef = ref(database, 'students');
                const coursesRef = ref(database, 'courses');
                const feesRef = ref(database, 'fees');
                const attendanceRef = ref(database, 'attendance');
                
                const studentsSnapshot = await get(studentsRef);
                const coursesSnapshot = await get(coursesRef);
                const feesSnapshot = await get(feesRef);
                const attendanceSnapshot = await get(attendanceRef);
                
                // Create a single CSV file with all data
                let csvContent = "EDUTECH MANAGEMENT SYSTEM - COMPLETE DATA EXPORT\n";
                csvContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
                
                // Add students data
                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    csvContent += "=== STUDENTS DATA ===\n\n";
                    csvContent += "Roll Number,ID,Name,Contact,Course,Fees,Created At\n";
                    
                    Object.keys(students).forEach(key => {
                        const student = students[key];
                        csvContent += `${student.rollNumber || 'N/A'},${key},"${student.name}","${student.contact}","${student.course}",${student.fees},"${student.createdAt}"\n`;
                    });
                    
                    csvContent += "\n\n";
                }
                
                // Add courses data
                if (coursesSnapshot.exists()) {
                    const courses = coursesSnapshot.val();
                    csvContent += "=== COURSES DATA ===\n\n";
                    csvContent += "ID,Course Name,Created At\n";
                    
                    Object.keys(courses).forEach(key => {
                        const course = courses[key];
                        csvContent += `${key},"${course.name}","${course.createdAt}"\n`;
                    });
                    
                    csvContent += "\n\n";
                }
                
                // Add fees data
                if (feesSnapshot.exists()) {
                    const fees = feesSnapshot.val();
                    const students = studentsSnapshot.val() || {};
                    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                    
                    csvContent += "=== FEES DATA ===\n\n";
                    csvContent += "Roll Number,Student ID,Student Name,Course,Fee Amount,Status,Month,Year,Created At\n";
                    
                    Object.keys(fees).forEach(key => {
                        const fee = fees[key];
                        const student = students[fee.studentId] || {};
                        csvContent += `${student.rollNumber || 'N/A'},${fee.studentId},"${student.name || 'N/A'}","${student.course || 'N/A'}",${student.fees || 'N/A'},"${fee.status}","${monthNames[fee.month]}",${fee.year},"${fee.createdAt}"\n`;
                    });
                    
                    csvContent += "\n\n";
                }
                
                // Add attendance data
                if (attendanceSnapshot.exists()) {
                    const attendance = attendanceSnapshot.val();
                    const students = studentsSnapshot.val() || {};
                    
                    csvContent += "=== ATTENDANCE DATA ===\n\n";
                    csvContent += "Roll Number,Student ID,Student Name,Course,Date,Status,Created At\n";
                    
                    Object.keys(attendance).forEach(key => {
                        const att = attendance[key];
                        const student = students[att.studentId] || {};
                        csvContent += `${student.rollNumber || 'N/A'},${att.studentId},"${student.name || 'N/A'}","${student.course || 'N/A'}",${att.date},"${att.status}","${att.createdAt}"\n`;
                    });
                }
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `edutech_complete_data_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('All data downloaded successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            } catch (error) {
                console.error("Error downloading all data:", error);
                showNotification('Error downloading data: ' + error.message, 'error');
            }
        }
        
        // Download functions for export modal
        window.downloadAllData = function() {
            downloadAllDataAsZip();
        };
        
        window.downloadStudentsData = function() {
            bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            downloadStudentsBtn.click();
        };
        
        window.downloadCoursesData = function() {
            bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            downloadCoursesBtn.click();
        };
        
        window.downloadFeesData = function() {
            bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            downloadFeesBtn.click();
        };
        
        window.downloadAttendanceData = function() {
            bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            downloadAttendanceBtn.click();
        };
        
        window.downloadSummaryReport = function() {
            downloadSummaryReport();
        };
        
        // Function to download summary report
        async function downloadSummaryReport() {
            try {
                console.log("Downloading summary report...");
                
                // Get all data
                const studentsRef = ref(database, 'students');
                const coursesRef = ref(database, 'courses');
                const feesRef = ref(database, 'fees');
                const attendanceRef = ref(database, 'attendance');
                
                const studentsSnapshot = await get(studentsRef);
                const coursesSnapshot = await get(coursesRef);
                const feesSnapshot = await get(feesRef);
                const attendanceSnapshot = await get(attendanceRef);
                
                // Create summary report
                let reportContent = "EDUTECH MANAGEMENT SYSTEM - SUMMARY REPORT\n";
                reportContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
                
                // Overall statistics
                reportContent += "=== OVERALL STATISTICS ===\n\n";
                
                const students = studentsSnapshot.val() || {};
                const courses = coursesSnapshot.val() || {};
                const fees = feesSnapshot.val() || {};
                const attendance = attendanceSnapshot.val() || {};
                
                reportContent += `Total Students: ${Object.keys(students).length}\n`;
                reportContent += `Total Courses: ${Object.keys(courses).length}\n`;
                reportContent += `Total Fee Records: ${Object.keys(fees).length}\n`;
                reportContent += `Total Attendance Records: ${Object.keys(attendance).length}\n\n`;
                
                // Course-wise student distribution
                reportContent += "=== COURSE-WISE STUDENT DISTRIBUTION ===\n\n";
                reportContent += "Course Name,Number of Students\n";
                
                const courseStudentCount = {};
                Object.values(courses).forEach(course => {
                    courseStudentCount[course.name] = 0;
                });
                
                Object.values(students).forEach(student => {
                    if (student.course && courseStudentCount[student.course] !== undefined) {
                        courseStudentCount[student.course]++;
                    }
                });
                
                Object.keys(courseStudentCount).forEach(courseName => {
                    reportContent += `"${courseName}",${courseStudentCount[courseName]}\n`;
                });
                
                reportContent += "\n";
                
                // Fee collection summary
                reportContent += "=== FEE COLLECTION SUMMARY ===\n\n";
                
                let totalFeesAmount = 0;
                let paidFeesAmount = 0;
                let unpaidFeesAmount = 0;
                
                Object.values(students).forEach(student => {
                    const feeAmount = parseInt(student.fees) || 0;
                    totalFeesAmount += feeAmount;
                });
                
                Object.values(fees).forEach(fee => {
                    const student = students[fee.studentId] || {};
                    const feeAmount = parseInt(student.fees) || 0;
                    
                    if (fee.status === 'paid') {
                        paidFeesAmount += feeAmount;
                    } else {
                        unpaidFeesAmount += feeAmount;
                    }
                });
                
                reportContent += `Total Fees Amount: PKR ${totalFeesAmount.toLocaleString()}\n`;
                reportContent += `Paid Fees Amount: PKR ${paidFeesAmount.toLocaleString()}\n`;
                reportContent += `Unpaid Fees Amount: PKR ${unpaidFeesAmount.toLocaleString()}\n`;
                reportContent += `Collection Rate: ${totalFeesAmount > 0 ? Math.round((paidFeesAmount / totalFeesAmount) * 100) : 0}%\n\n`;
                
                // Monthly fee collection
                reportContent += "=== MONTHLY FEE COLLECTION ===\n\n";
                reportContent += "Month,Year,Paid Count,Unpaid Count,Collection Rate\n";
                
                const monthlyFeeData = {};
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                
                Object.values(fees).forEach(fee => {
                    const key = `${fee.year}-${fee.month}`;
                    if (!monthlyFeeData[key]) {
                        monthlyFeeData[key] = { paid: 0, unpaid: 0 };
                    }
                    
                    if (fee.status === 'paid') {
                        monthlyFeeData[key].paid++;
                    } else {
                        monthlyFeeData[key].unpaid++;
                    }
                });
                
                Object.keys(monthlyFeeData).sort().forEach(key => {
                    const [year, month] = key.split('-');
                    const data = monthlyFeeData[key];
                    const total = data.paid + data.unpaid;
                    const rate = total > 0 ? Math.round((data.paid / total) * 100) : 0;
                    
                    reportContent += `${monthNames[parseInt(month)]},${year},${data.paid},${data.unpaid},${rate}%\n`;
                });
                
                // Attendance summary
                reportContent += "\n=== ATTENDANCE SUMMARY ===\n\n";
                
                let totalAttendanceRecords = 0;
                let presentAttendanceRecords = 0;
                
                Object.values(attendance).forEach(att => {
                    totalAttendanceRecords++;
                    if (att.status === 'present') {
                        presentAttendanceRecords++;
                    }
                });
                
                const overallAttendanceRate = totalAttendanceRecords > 0 ? Math.round((presentAttendanceRecords / totalAttendanceRecords) * 100) : 0;
                
                reportContent += `Total Attendance Records: ${totalAttendanceRecords}\n`;
                reportContent += `Present Records: ${presentAttendanceRecords}\n`;
                reportContent += `Absent Records: ${totalAttendanceRecords - presentAttendanceRecords}\n`;
                reportContent += `Overall Attendance Rate: ${overallAttendanceRate}%\n\n`;
                
                // Student-wise attendance rates
                reportContent += "=== STUDENT-WISE ATTENDANCE RATES ===\n\n";
                reportContent += "Roll Number,Student Name,Course,Attendance Rate\n";
                
                const studentAttendanceData = {};
                
                Object.values(attendance).forEach(att => {
                    if (!studentAttendanceData[att.studentId]) {
                        studentAttendanceData[att.studentId] = { total: 0, present: 0 };
                    }
                    
                    studentAttendanceData[att.studentId].total++;
                    if (att.status === 'present') {
                        studentAttendanceData[att.studentId].present++;
                    }
                });
                
                Object.keys(studentAttendanceData).forEach(studentId => {
                    const student = students[studentId] || {};
                    const data = studentAttendanceData[studentId];
                    const rate = data.total > 0 ? Math.round((data.present / data.total) * 100) : 0;
                    
                    reportContent += `${student.rollNumber || 'N/A'},"${student.name || 'N/A'}","${student.course || 'N/A'}",${rate}%\n`;
                });
                
                // Create download link
                const blob = new Blob([reportContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `edutech_summary_report_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Summary report downloaded successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('exportDataModal')).hide();
            } catch (error) {
                console.error("Error downloading summary report:", error);
                showNotification('Error downloading summary report: ' + error.message, 'error');
            }
        }
        
        // CSV Download Functions
        
        // Download students data
        downloadStudentsBtn.addEventListener('click', async () => {
            try {
                console.log("Downloading students data...");
                
                const studentsRef = ref(database, 'students');
                const snapshot = await get(studentsRef);
                
                if (snapshot.exists()) {
                    const students = snapshot.val();
                    
                    // Create CSV content
                    let csvContent = "Roll Number,ID,Name,Contact,Course,Fees,Created At\n";
                    
                    Object.keys(students).forEach(key => {
                        const student = students[key];
                        csvContent += `${student.rollNumber || 'N/A'},${key},"${student.name}","${student.contact}","${student.course}",${student.fees},"${student.createdAt}"\n`;
                    });
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `students_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Students data downloaded successfully!', 'success');
                } else {
                    showNotification('No students data found!', 'error');
                }
            } catch (error) {
                console.error("Error downloading students data:", error);
                showNotification('Error downloading students data: ' + error.message, 'error');
            }
        });
        
        // Download courses data
        downloadCoursesBtn.addEventListener('click', async () => {
            try {
                console.log("Downloading courses data...");
                
                const coursesRef = ref(database, 'courses');
                const snapshot = await get(coursesRef);
                
                if (snapshot.exists()) {
                    const courses = snapshot.val();
                    
                    // Create CSV content
                    let csvContent = "ID,Course Name,Created At\n";
                    
                    Object.keys(courses).forEach(key => {
                        const course = courses[key];
                        csvContent += `${key},"${course.name}","${course.createdAt}"\n`;
                    });
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `courses_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Courses data downloaded successfully!', 'success');
                } else {
                    showNotification('No courses data found!', 'error');
                }
            } catch (error) {
                console.error("Error downloading courses data:", error);
                showNotification('Error downloading courses data: ' + error.message, 'error');
            }
        });
        
        // Download fees data
        downloadFeesBtn.addEventListener('click', async () => {
            try {
                console.log("Downloading fees data...");
                
                const month = document.getElementById('monthSelect').value;
                const year = document.getElementById('yearSelect').value;
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                
                const feesRef = ref(database, 'fees');
                const snapshot = await get(feesRef);
                
                if (snapshot.exists()) {
                    const fees = snapshot.val();
                    
                    // Get students data for student names
                    const studentsRef = ref(database, 'students');
                    const studentsSnapshot = await get(studentsRef);
                    const students = studentsSnapshot.val() || {};
                    
                    // Create CSV content
                    let csvContent = "Roll Number,Student ID,Student Name,Course,Fee Amount,Status,Month,Year,Created At\n";
                    
                    Object.keys(fees).forEach(key => {
                        const fee = fees[key];
                        
                        // Only include fees for selected month and year
                        if (fee.month == month && fee.year == year) {
                            const student = students[fee.studentId] || {};
                            csvContent += `${student.rollNumber || 'N/A'},${fee.studentId},"${student.name || 'N/A'}","${student.course || 'N/A'}",${student.fees || 'N/A'},"${fee.status}","${monthNames[fee.month]}",${fee.year},"${fee.createdAt}"\n`;
                        }
                    });
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `fees_${monthNames[month]}_${year}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Fees data downloaded successfully!', 'success');
                } else {
                    showNotification('No fees data found!', 'error');
                }
            } catch (error) {
                console.error("Error downloading fees data:", error);
                showNotification('Error downloading fees data: ' + error.message, 'error');
            }
        });
        
        // Download attendance data
        downloadAttendanceBtn.addEventListener('click', async () => {
            try {
                console.log("Downloading attendance data...");
                
                const attendanceRef = ref(database, 'attendance');
                const snapshot = await get(attendanceRef);
                
                if (snapshot.exists()) {
                    const attendance = snapshot.val();
                    
                    // Get students data for student names
                    const studentsRef = ref(database, 'students');
                    const studentsSnapshot = await get(studentsRef);
                    const students = studentsSnapshot.val() || {};
                    
                    // Create CSV content
                    let csvContent = "Roll Number,Student ID,Student Name,Course,Date,Status,Created At\n";
                    
                    Object.keys(attendance).forEach(key => {
                        const att = attendance[key];
                        const student = students[att.studentId] || {};
                        csvContent += `${student.rollNumber || 'N/A'},${att.studentId},"${student.name || 'N/A'}","${student.course || 'N/A'}",${att.date},"${att.status}","${att.createdAt}"\n`;
                    });
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `attendance_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Attendance data downloaded successfully!', 'success');
                } else {
                    showNotification('No attendance data found!', 'error');
                }
            } catch (error) {
                console.error("Error downloading attendance data:", error);
                showNotification('Error downloading attendance data: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
