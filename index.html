<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #f39c12;
            --secondary-color: #e67e22;
            --accent-color: #f1c40f;
            --light-bg: #fef9e7;
            --dark-text: #2c3e50;
            --sidebar-bg: #34495e;
            --sidebar-hover: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: var(--sidebar-bg);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-weight: 700;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .sidebar-menu .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu .nav-link:hover {
            background-color: var(--sidebar-hover);
            border-left-color: var(--accent-color);
        }
        
        .sidebar-menu .nav-link.active {
            background-color: var(--sidebar-hover);
            border-left-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .sidebar-menu .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        /* Top Bar */
        .top-bar {
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .top-bar h2 {
            margin: 0;
            color: var(--dark-text);
        }
        
        /* Card Styles */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .dashboard-card {
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fff 0%, var(--light-bg) 100%);
        }
        
        .dashboard-card:hover {
            background: linear-gradient(135deg, var(--light-bg) 0%, #fff 100%);
        }
        
        .dashboard-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .status-paid {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-unpaid {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .attendance-present {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .attendance-absent {
            background-color: #fadbd8;
            color: #e74c3c;
        }
        
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            background: white;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header i {
            font-size: 3rem;
            color: var(--primary-color);
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(241, 196, 15, 0.25);
        }
        
        .footer {
            background-color: var(--sidebar-bg);
            color: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
            margin-left: 250px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }
        
        .notification.success {
            background-color: #27ae60;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        
        .connection-status.connected {
            background-color: #27ae60;
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Mobile Responsiveness */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .footer {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <div class="login-container card">
            <div class="login-header">
                <i class="bi bi-mortarboard-fill"></i>
                <h2>EduTech Management System</h2>
                <p class="text-muted">Admin Login</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Admin Username</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <input type="text" class="form-control" id="username" placeholder="Enter admin username" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Admin Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input type="password" class="form-control" id="password" placeholder="Enter admin password" required>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
                <div class="loading-spinner" id="loginSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Signing in...</p>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">Demo Credentials: Username: shariq, Password: shariq123</small>
                </div>
                <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearDataBtn">
                        <i class="bi bi-arrow-clockwise"></i> Clear Login Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Menu Toggle Button for Mobile -->
        <button class="menu-toggle" id="menuToggle">
            <i class="bi bi-list"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-mortarboard-fill"></i>
                <h3>EduTech</h3>
            </div>
            <div class="sidebar-menu">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" data-section="students">
                        <i class="bi bi-people-fill"></i> Students
                    </a>
                    <a class="nav-link" href="#" data-section="courses">
                        <i class="bi bi-book-fill"></i> Courses
                    </a>
                    <a class="nav-link" href="#" data-section="fees">
                        <i class="bi bi-cash-stack"></i> Fees
                    </a>
                    <a class="nav-link" href="#" data-section="attendance">
                        <i class="bi bi-calendar-check-fill"></i> Attendance
                    </a>
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="d-flex align-items-center">
                    <span class="me-3">Welcome, <strong id="adminName">Admin</strong></span>
                    <img src="https://picsum.photos/seed/admin/40/40.jpg" alt="Admin" class="rounded-circle">
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card dashboard-card">
                            <i class="bi bi-people-fill"></i>
                            <h3 id="totalStudents">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card dashboard-card">
                            <i class="bi bi-book-fill"></i>
                            <h3 id="totalCourses">0</h3>
                            <p>Total Courses</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card dashboard-card">
                            <i class="bi bi-cash-stack"></i>
                            <h3 id="totalFees">₹0</h3>
                            <p>Total Fees</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card dashboard-card">
                            <i class="bi bi-calendar-check-fill"></i>
                            <h3 id="attendanceRate">0%</h3>
                            <p>Attendance Rate</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Recent Students</div>
                            <div class="card-body">
                                <ul id="recentStudents" class="list-group list-group-flush">
                                    <!-- Recent students will be added here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Fee Status</div>
                            <div class="card-body">
                                <canvas id="feeChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="studentsSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Students Management</h5>
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="bi bi-plus-circle"></i> Add Student
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Course</th>
                                        <th>Fees (PKR)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <!-- Students will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses Section -->
            <div id="coursesSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Courses Management</h5>
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                            <i class="bi bi-plus-circle"></i> Add Course
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Course Name</th>
                                        <th>Students Enrolled</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coursesTableBody">
                                    <!-- Courses will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fees Section -->
            <div id="feesSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Fees Management</h5>
                        <div class="d-flex">
                            <select id="monthSelect" class="form-select me-2">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="yearSelect" class="form-select">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Student Name</th>
                                        <th>Course</th>
                                        <th>Fee Amount (PKR)</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feesTableBody">
                                    <!-- Fees will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Attendance Management</h5>
                        <div class="d-flex">
                            <input type="date" id="attendanceDate" class="form-control me-2">
                            <button id="markAttendanceBtn" class="btn btn-light me-2">
                                <i class="bi bi-check2-square"></i> Mark Attendance
                            </button>
                            <button id="deleteAttendanceBtn" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i> Delete Month Data
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Student Name</th>
                                        <th>Course</th>
                                        <th>Attendance Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Attendance will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h5>EduTech Management System</h5>
                        <p>Comprehensive solution for educational institutions</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p>&copy; 2023 EduTech Management. All rights reserved.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentContact" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="studentContact" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentFees" class="form-label">Fees (PKR)</label>
                            <input type="number" class="form-control" id="studentFees" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentCourse" class="form-label">Course</label>
                            <select class="form-select" id="studentCourse" required>
                                <option value="">Select Course</option>
                                <!-- Courses will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Add Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label for="editStudentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentContact" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="editStudentContact" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentFees" class="form-label">Fees (PKR)</label>
                            <input type="number" class="form-control" id="editStudentFees" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentCourse" class="form-label">Course</label>
                            <select class="form-select" id="editStudentCourse" required>
                                <option value="">Select Course</option>
                                <!-- Courses will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Update Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="addCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm">
                        <div class="mb-3">
                            <label for="courseName" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="courseName" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Add Course</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Course Modal -->
    <div class="modal fade" id="editCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCourseForm">
                        <input type="hidden" id="editCourseId">
                        <div class="mb-3">
                            <label for="editCourseName" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="editCourseName" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Update Course</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Enroll Student Modal -->
    <div class="modal fade" id="enrollStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll Student in Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="enrollStudentForm">
                        <input type="hidden" id="enrollCourseId">
                        <div class="mb-3">
                            <label for="enrollStudentName" class="form-label">Student Name</label>
                            <select class="form-select" id="enrollStudentName" required>
                                <option value="">Select Student</option>
                                <!-- Students will be populated dynamically -->
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Enroll Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark Attendance Modal -->
    <div class="modal fade" id="markAttendanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Attendance for <span id="attendanceDateDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student Name</th>
                                    <th>Course</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBodyModal">
                                <!-- Students will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="saveAttendanceBtn">Save Attendance</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_jAuvdnqVA-g4JzL90fukKGGN_U1mMAI",
            authDomain: "edutech-ead49.firebaseapp.com",
            databaseURL: "https://edutech-ead49-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "edutech-ead49",
            storageBucket: "edutech-ead49.firebasestorage.app",
            messagingSenderId: "503549426705",
            appId: "1:503549426705:web:c9130b6202d5f9b31185b0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Firestore with persistence
        let db;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const navLinks = document.querySelectorAll('.sidebar-menu .nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const notification = document.getElementById('notification');
        const loginSpinner = document.getElementById('loginSpinner');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const pageTitle = document.getElementById('pageTitle');
        const adminName = document.getElementById('adminName');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        
        // Clear login data button
        clearDataBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            showNotification('Login data cleared successfully!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        });
        
        // Initialize Firestore with offline persistence
        async function initializeFirestore() {
            try {
                db = getFirestore(app);
                await enableIndexedDbPersistence(db);
                console.log("Firestore initialized successfully with offline persistence");
                showConnectionStatus('Connected to database', 'connected');
                return true;
            } catch (error) {
                console.error("Error initializing Firestore:", error);
                showConnectionStatus('Database connection failed: ' + error.message, 'disconnected');
                return false;
            }
        }
        
        // Show connection status
        function showConnectionStatus(message, type) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${type}`;
            connectionStatus.style.display = 'block';
            
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 5000);
        }
        
        // Check if user is already logged in
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firestore
            const firestoreInitialized = await initializeFirestore();
            
            if (!firestoreInitialized) {
                showNotification('Failed to connect to database. Please check your connection.', 'error');
                return;
            }
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const username = localStorage.getItem('username');
            
            // Only show dashboard if both isLoggedIn is true and username is valid
            if (isLoggedIn === 'true' && username === 'shariq') {
                loginScreen.style.display = 'none';
                dashboard.style.display = 'block';
                adminName.textContent = username;
                loadDashboard();
            } else {
                // Clear any invalid login data
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                loginScreen.style.display = 'block';
                dashboard.style.display = 'none';
            }
            
            // Set current date for attendance
            const today = new Date();
            document.getElementById('attendanceDate').value = today.toISOString().split('T')[0];
        });
        
        // Login functionality
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Show loading spinner
            loginSpinner.style.display = 'block';
            
            // Fixed admin credentials
            const adminUsername = "shariq";
            const adminPassword = "shariq123";
            
            // Simple validation
            setTimeout(() => {
                if (username === adminUsername && password === adminPassword) {
                    // Set login state in localStorage
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', username);
                    
                    // Show dashboard
                    loginScreen.style.display = 'none';
                    dashboard.style.display = 'block';
                    adminName.textContent = username;
                    
                    // Show success message
                    showNotification('Login successful!', 'success');
                    loginSpinner.style.display = 'none';
                    
                    // Load dashboard data
                    loadDashboard();
                } else {
                    // Show error message
                    showNotification('Invalid username or password!', 'error');
                    loginSpinner.style.display = 'none';
                }
            }, 1000); // Simulate network delay
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            // Clear login state from localStorage
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            
            // Show login screen
            loginScreen.style.display = 'block';
            dashboard.style.display = 'none';
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Show success message
            showNotification('Logged out successfully!', 'success');
        });
        
        // Navigation functionality
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                
                if (section) {
                    // Update active nav link
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show selected section
                    contentSections.forEach(s => s.style.display = 'none');
                    document.getElementById(`${section}Section`).style.display = 'block';
                    
                    // Update page title
                    pageTitle.textContent = link.textContent.trim();
                    
                    // Load section data
                    if (section === 'dashboard') {
                        loadDashboard();
                    } else if (section === 'students') {
                        loadStudents();
                    } else if (section === 'courses') {
                        loadCourses();
                    } else if (section === 'fees') {
                        loadFees();
                    } else if (section === 'attendance') {
                        loadAttendance();
                    }
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                }
            });
        });
        
        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log("Loading dashboard data...");
                
                // Get total students
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                console.log("Students snapshot:", studentsSnapshot.size);
                document.getElementById('totalStudents').textContent = studentsSnapshot.size;
                
                // Get total courses
                const coursesSnapshot = await getDocs(collection(db, 'courses'));
                console.log("Courses snapshot:", coursesSnapshot.size);
                document.getElementById('totalCourses').textContent = coursesSnapshot.size;
                
                // Get total fees
                let totalFees = 0;
                studentsSnapshot.forEach(doc => {
                    totalFees += parseInt(doc.data().fees) || 0;
                });
                document.getElementById('totalFees').textContent = `₹${totalFees.toLocaleString()}`;
                
                // Get attendance rate (simplified calculation)
                const attendanceSnapshot = await getDocs(collection(db, 'attendance'));
                console.log("Attendance snapshot:", attendanceSnapshot.size);
                let totalRecords = 0;
                let presentRecords = 0;
                
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'present') {
                        presentRecords++;
                    }
                    totalRecords++;
                });
                
                const attendanceRate = totalRecords > 0 ? Math.round((presentRecords / totalRecords) * 100) : 0;
                document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                
                // Get recent students
                const recentStudentsList = document.getElementById('recentStudents');
                recentStudentsList.innerHTML = '';
                
                const q = query(collection(db, 'students'), orderBy('createdAt', 'desc'));
                const recentStudentsSnapshot = await getDocs(q);
                let count = 0;
                recentStudentsSnapshot.forEach(doc => {
                    if (count < 5) {
                        const student = doc.data();
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${student.name}</strong>
                                <div class="text-muted small">${student.course}</div>
                            </div>
                            <span class="badge bg-primary rounded-pill">₹${student.fees}</span>
                        `;
                        recentStudentsList.appendChild(li);
                        count++;
                    }
                });
                
                // Initialize fee chart (simplified for this example)
                const feeChartCanvas = document.getElementById('feeChart');
                if (feeChartCanvas) {
                    const ctx = feeChartCanvas.getContext('2d');
                    // This is a placeholder for a chart - in a real app, you'd use Chart.js or similar
                    ctx.fillStyle = '#f39c12';
                    ctx.fillRect(0, 0, feeChartCanvas.width, feeChartCanvas.height);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Fee Status Chart', feeChartCanvas.width / 2, feeChartCanvas.height / 2);
                }
                
                console.log("Dashboard data loaded successfully");
            } catch (error) {
                console.error("Error loading dashboard:", error);
                showNotification('Error loading dashboard: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Load students
        async function loadStudents() {
            try {
                console.log("Loading students...");
                
                const studentsTableBody = document.getElementById('studentsTableBody');
                studentsTableBody.innerHTML = '';
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                console.log("Found", studentsSnapshot.size, "students");
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${student.name}</td>
                        <td>${student.contact}</td>
                        <td>${student.course}</td>
                        <td>₹${student.fees}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editStudent('${doc.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${doc.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    studentsTableBody.appendChild(row);
                });
                
                // Populate course dropdowns
                populateCourseDropdowns();
                
                console.log("Students loaded successfully");
            } catch (error) {
                console.error("Error loading students:", error);
                showNotification('Error loading students: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Add student
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Adding student...");
                
                const name = document.getElementById('studentName').value;
                const contact = document.getElementById('studentContact').value;
                const fees = document.getElementById('studentFees').value;
                const course = document.getElementById('studentCourse').value;
                
                console.log("Student data:", { name, contact, fees, course });
                
                const docRef = await addDoc(collection(db, 'students'), {
                    name,
                    contact,
                    fees,
                    course,
                    createdAt: serverTimestamp()
                });
                
                console.log("Student added with ID:", docRef.id);
                
                showNotification('Student added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                document.getElementById('addStudentForm').reset();
                loadStudents();
            } catch (error) {
                console.error("Error adding student:", error);
                showNotification('Error adding student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Edit student
        window.editStudent = async function(id) {
            try {
                console.log("Editing student:", id);
                
                const studentDoc = await getDoc(doc(db, 'students', id));
                const student = studentDoc.data();
                
                console.log("Student data:", student);
                
                document.getElementById('editStudentId').value = id;
                document.getElementById('editStudentName').value = student.name;
                document.getElementById('editStudentContact').value = student.contact;
                document.getElementById('editStudentFees').value = student.fees;
                document.getElementById('editStudentCourse').value = student.course;
                
                const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading student data:", error);
                showNotification('Error loading student data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Update student
        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Updating student...");
                
                const id = document.getElementById('editStudentId').value;
                const name = document.getElementById('editStudentName').value;
                const contact = document.getElementById('editStudentContact').value;
                const fees = document.getElementById('editStudentFees').value;
                const course = document.getElementById('editStudentCourse').value;
                
                console.log("Updated student data:", { id, name, contact, fees, course });
                
                await updateDoc(doc(db, 'students', id), {
                    name,
                    contact,
                    fees,
                    course
                });
                
                console.log("Student updated successfully");
                
                showNotification('Student updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
            } catch (error) {
                console.error("Error updating student:", error);
                showNotification('Error updating student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete student
        window.deleteStudent = async function(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    console.log("Deleting student:", id);
                    
                    await deleteDoc(doc(db, 'students', id));
                    
                    console.log("Student deleted successfully");
                    
                    showNotification('Student deleted successfully!', 'success');
                    loadStudents();
                } catch (error) {
                    console.error("Error deleting student:", error);
                    showNotification('Error deleting student: ' + error.message, 'error');
                    showConnectionStatus('Database error: ' + error.message, 'disconnected');
                }
            }
        };
        
        // Load courses
        async function loadCourses() {
            try {
                console.log("Loading courses...");
                
                const coursesTableBody = document.getElementById('coursesTableBody');
                coursesTableBody.innerHTML = '';
                
                const coursesSnapshot = await getDocs(collection(db, 'courses'));
                console.log("Found", coursesSnapshot.size, "courses");
                
                coursesSnapshot.forEach(doc => {
                    const course = doc.data();
                    
                    // Count enrolled students
                    const q = query(collection(db, 'students'), where('course', '==', course.name));
                    getDocs(q).then(studentSnapshot => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${doc.id}</td>
                            <td>${course.name}</td>
                            <td>${studentSnapshot.size}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editCourse('${doc.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteCourse('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="enrollStudent('${doc.id}')">
                                    <i class="bi bi-person-plus"></i> Enroll
                                </button>
                            </td>
                        `;
                        coursesTableBody.appendChild(row);
                    });
                });
                
                console.log("Courses loaded successfully");
            } catch (error) {
                console.error("Error loading courses:", error);
                showNotification('Error loading courses: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Add course
        document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Adding course...");
                
                const name = document.getElementById('courseName').value;
                
                console.log("Course data:", { name });
                
                const docRef = await addDoc(collection(db, 'courses'), {
                    name,
                    createdAt: serverTimestamp()
                });
                
                console.log("Course added with ID:", docRef.id);
                
                showNotification('Course added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();
                document.getElementById('addCourseForm').reset();
                loadCourses();
            } catch (error) {
                console.error("Error adding course:", error);
                showNotification('Error adding course: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Edit course
        window.editCourse = async function(id) {
            try {
                console.log("Editing course:", id);
                
                const courseDoc = await getDoc(doc(db, 'courses', id));
                const course = courseDoc.data();
                
                console.log("Course data:", course);
                
                document.getElementById('editCourseId').value = id;
                document.getElementById('editCourseName').value = course.name;
                
                const modal = new bootstrap.Modal(document.getElementById('editCourseModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading course data:", error);
                showNotification('Error loading course data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Update course
        document.getElementById('editCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Updating course...");
                
                const id = document.getElementById('editCourseId').value;
                const name = document.getElementById('editCourseName').value;
                
                console.log("Updated course data:", { id, name });
                
                await updateDoc(doc(db, 'courses', id), {
                    name
                });
                
                console.log("Course updated successfully");
                
                showNotification('Course updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
                loadCourses();
            } catch (error) {
                console.error("Error updating course:", error);
                showNotification('Error updating course: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete course
        window.deleteCourse = async function(id) {
            if (confirm('Are you sure you want to delete this course?')) {
                try {
                    console.log("Deleting course:", id);
                    
                    await deleteDoc(doc(db, 'courses', id));
                    
                    console.log("Course deleted successfully");
                    
                    showNotification('Course deleted successfully!', 'success');
                    loadCourses();
                } catch (error) {
                    console.error("Error deleting course:", error);
                    showNotification('Error deleting course: ' + error.message, 'error');
                    showConnectionStatus('Database error: ' + error.message, 'disconnected');
                }
            }
        };
        
        // Enroll student in course
        window.enrollStudent = async function(courseId) {
            try {
                console.log("Enrolling student in course:", courseId);
                
                document.getElementById('enrollCourseId').value = courseId;
                
                // Populate student dropdown
                const studentDropdown = document.getElementById('enrollStudentName');
                studentDropdown.innerHTML = '<option value="">Select Student</option>';
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = student.name;
                    studentDropdown.appendChild(option);
                });
                
                const modal = new bootstrap.Modal(document.getElementById('enrollStudentModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading students for enrollment:", error);
                showNotification('Error loading students: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Process enrollment
        document.getElementById('enrollStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                console.log("Processing enrollment...");
                
                const courseId = document.getElementById('enrollCourseId').value;
                const studentId = document.getElementById('enrollStudentName').value;
                
                console.log("Enrollment data:", { courseId, studentId });
                
                // Get course name
                const courseDoc = await getDoc(doc(db, 'courses', courseId));
                const courseName = courseDoc.data().name;
                
                // Update student's course
                await updateDoc(doc(db, 'students', studentId), {
                    course: courseName
                });
                
                console.log("Student enrolled successfully");
                
                showNotification('Student enrolled successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal')).hide();
                loadCourses();
                loadStudents();
            } catch (error) {
                console.error("Error enrolling student:", error);
                showNotification('Error enrolling student: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Load fees
        function loadFees() {
            // Set current month and year
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth();
            
            // Populate year dropdown
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            const currentYear = now.getFullYear();
            
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Load fees data
            loadFeesData();
        }
        
        // Load fees data based on selected month and year
        async function loadFeesData() {
            try {
                console.log("Loading fees data...");
                
                const month = document.getElementById('monthSelect').value;
                const year = document.getElementById('yearSelect').value;
                
                const feesTableBody = document.getElementById('feesTableBody');
                feesTableBody.innerHTML = '';
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                console.log("Found", studentsSnapshot.size, "students for fees");
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    // Check if fee record exists for this month/year
                    const q = query(
                        collection(db, 'fees'),
                        where('studentId', '==', studentId),
                        where('month', '==', parseInt(month)),
                        where('year', '==', parseInt(year))
                    );
                    
                    getDocs(q).then(feeSnapshot => {
                        let status = 'unpaid';
                        let feeId = '';
                        
                        if (!feeSnapshot.empty) {
                            const feeDoc = feeSnapshot.docs[0];
                            status = feeDoc.data().status;
                            feeId = feeDoc.id;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.course}</td>
                            <td>₹${student.fees}</td>
                            <td>
                                <span class="${status === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                    ${status === 'paid' ? 'Paid' : 'Unpaid'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm ${status === 'paid' ? 'btn-outline-warning' : 'btn-outline-success'}" 
                                        onclick="toggleFeeStatus('${studentId}', '${month}', '${year}', '${status}', '${feeId}')">
                                    ${status === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}
                                </button>
                            </td>
                        `;
                        feesTableBody.appendChild(row);
                    });
                });
                
                console.log("Fees data loaded successfully");
            } catch (error) {
                console.error("Error loading fees data:", error);
                showNotification('Error loading fees: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Toggle fee status
        window.toggleFeeStatus = async function(studentId, month, year, currentStatus, feeId) {
            try {
                console.log("Toggling fee status...");
                
                const newStatus = currentStatus === 'paid' ? 'unpaid' : 'paid';
                
                if (feeId) {
                    // Update existing fee record
                    await updateDoc(doc(db, 'fees', feeId), {
                        status: newStatus
                    });
                } else {
                    // Create new fee record
                    await addDoc(collection(db, 'fees'), {
                        studentId,
                        month: parseInt(month),
                        year: parseInt(year),
                        status: newStatus,
                        createdAt: serverTimestamp()
                    });
                }
                
                console.log("Fee status updated successfully");
                
                showNotification(`Fee marked as ${newStatus}!`, 'success');
                loadFeesData();
            } catch (error) {
                console.error("Error updating fee status:", error);
                showNotification('Error updating fee status: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        };
        
        // Month/year change event listeners
        document.getElementById('monthSelect').addEventListener('change', loadFeesData);
        document.getElementById('yearSelect').addEventListener('change', loadFeesData);
        
        // Load attendance
        async function loadAttendance() {
            try {
                console.log("Loading attendance...");
                
                const attendanceTableBody = document.getElementById('attendanceTableBody');
                attendanceTableBody.innerHTML = '';
                
                // Set today's date as default
                const today = new Date();
                document.getElementById('attendanceDate').value = today.toISOString().split('T')[0];
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                console.log("Found", studentsSnapshot.size, "students for attendance");
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    // Calculate attendance rate (simplified)
                    const q = query(collection(db, 'attendance'), where('studentId', '==', studentId));
                    getDocs(q).then(attSnapshot => {
                        let totalDays = 0;
                        let presentDays = 0;
                        
                        attSnapshot.forEach(attDoc => {
                            totalDays++;
                            if (attDoc.data().status === 'present') {
                                presentDays++;
                            }
                        });
                        
                        const attendanceRate = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.course}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${attendanceRate}%; background-color: ${attendanceRate > 70 ? '#27ae60' : attendanceRate > 40 ? '#f39c12' : '#e74c3c'};"
                                         aria-valuenow="${attendanceRate}" aria-valuemin="0" aria-valuemax="100">
                                        ${attendanceRate}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewStudentAttendance('${studentId}')">
                                    <i class="bi bi-calendar3"></i> View
                                </button>
                            </td>
                        `;
                        attendanceTableBody.appendChild(row);
                    });
                });
                
                console.log("Attendance loaded successfully");
            } catch (error) {
                console.error("Error loading attendance:", error);
                showNotification('Error loading attendance: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
        
        // Mark attendance button
        document.getElementById('markAttendanceBtn').addEventListener('click', async () => {
            try {
                console.log("Marking attendance...");
                
                const date = document.getElementById('attendanceDate').value;
                if (!date) {
                    showNotification('Please select a date!', 'error');
                    return;
                }
                
                document.getElementById('attendanceDateDisplay').textContent = new Date(date).toLocaleDateString();
                
                // Populate attendance table
                const attendanceTableBodyModal = document.getElementById('attendanceTableBodyModal');
                attendanceTableBodyModal.innerHTML = '';
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                console.log("Found", studentsSnapshot.size, "students for marking attendance");
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    // Check if attendance already exists for this date
                    const q = query(
                        collection(db, 'attendance'),
                        where('studentId', '==', studentId),
                        where('date', '==', date)
                    );
                    
                    getDocs(q).then(attSnapshot => {
                        let status = 'absent';
                        
                        if (!attSnapshot.empty) {
                            status = attSnapshot.docs[0].data().status;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.course}</td>
                            <td>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="attendance-${studentId}" 
                                           id="present-${studentId}" value="present" ${status === 'present' ? 'checked' : ''}>
                                    <label class="form-check-label" for="present-${studentId}">Present</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="attendance-${studentId}" 
                                           id="absent-${studentId}" value="absent" ${status === 'absent' ? 'checked' : ''}>
                                    <label class="form-check-label" for="absent-${studentId}">Absent</label>
                                </div>
                            </td>
                        `;
                        attendanceTableBodyModal.appendChild(row);
                    });
                });
                
                const modal = new bootstrap.Modal(document.getElementById('markAttendanceModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading attendance data:", error);
                showNotification('Error loading attendance data: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Save attendance
        document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
            try {
                console.log("Saving attendance...");
                
                const date = document.getElementById('attendanceDate').value;
                
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                const batch = writeBatch(db);
                
                studentsSnapshot.forEach(doc => {
                    const studentId = doc.id;
                    const statusRadio = document.querySelector(`input[name="attendance-${studentId}"]:checked`);
                    
                    if (statusRadio) {
                        const status = statusRadio.value;
                        
                        // Check if attendance record already exists
                        const q = query(
                            collection(db, 'attendance'),
                            where('studentId', '==', studentId),
                            where('date', '==', date)
                        );
                        
                        getDocs(q).then(attSnapshot => {
                            if (!attSnapshot.empty) {
                                // Update existing record
                                const attId = attSnapshot.docs[0].id;
                                batch.update(doc(db, 'attendance', attId), {
                                    status
                                });
                            } else {
                                // Create new record
                                const newAttRef = doc(collection(db, 'attendance'));
                                batch.set(newAttRef, {
                                    studentId,
                                    date,
                                    status,
                                    createdAt: serverTimestamp()
                                });
                            }
                            
                            // Commit the batch
                            batch.commit().then(() => {
                                console.log("Attendance saved successfully");
                                showNotification('Attendance saved successfully!', 'success');
                                bootstrap.Modal.getInstance(document.getElementById('markAttendanceModal')).hide();
                                loadAttendance();
                            }).catch(error => {
                                console.error("Error saving attendance:", error);
                                showNotification('Error saving attendance: ' + error.message, 'error');
                                showConnectionStatus('Database error: ' + error.message, 'disconnected');
                            });
                        });
                    }
                });
            } catch (error) {
                console.error("Error saving attendance:", error);
                showNotification('Error saving attendance: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        });
        
        // Delete attendance data for a month
        document.getElementById('deleteAttendanceBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all attendance data for the selected month? This action cannot be undone.')) {
                try {
                    console.log("Deleting attendance data...");
                    
                    const date = new Date(document.getElementById('attendanceDate').value);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    
                    // Get all attendance records for the selected month
                    const q = query(
                        collection(db, 'attendance'),
                        where('date', '>=', new Date(year, month, 1)),
                        where('date', '<', new Date(year, month + 1, 1))
                    );
                    
                    getDocs(q).then(snapshot => {
                        const batch = writeBatch(db);
                        
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        return batch.commit();
                    })
                    .then(() => {
                        console.log("Attendance data deleted successfully");
                        showNotification('Attendance data deleted successfully!', 'success');
                        loadAttendance();
                    })
                    .catch(error => {
                        console.error("Error deleting attendance data:", error);
                        showNotification('Error deleting attendance data: ' + error.message, 'error');
                        showConnectionStatus('Database error: ' + error.message, 'disconnected');
                    });
                } catch (error) {
                    console.error("Error deleting attendance data:", error);
                    showNotification('Error deleting attendance data: ' + error.message, 'error');
                    showConnectionStatus('Database error: ' + error.message, 'disconnected');
                }
            }
        });
        
        // View student attendance (placeholder function)
        window.viewStudentAttendance = function(studentId) {
            showNotification('Student attendance view would open here', 'success');
        };
        
        // Populate course dropdowns
        async function populateCourseDropdowns() {
            try {
                console.log("Populating course dropdowns...");
                
                const studentCourseDropdown = document.getElementById('studentCourse');
                const editStudentCourseDropdown = document.getElementById('editStudentCourse');
                
                studentCourseDropdown.innerHTML = '<option value="">Select Course</option>';
                editStudentCourseDropdown.innerHTML = '<option value="">Select Course</option>';
                
                const coursesSnapshot = await getDocs(collection(db, 'courses'));
                console.log("Found", coursesSnapshot.size, "courses for dropdowns");
                
                coursesSnapshot.forEach(doc => {
                    const course = doc.data();
                    
                    const option1 = document.createElement('option');
                    option1.value = course.name;
                    option1.textContent = course.name;
                    studentCourseDropdown.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = course.name;
                    option2.textContent = course.name;
                    editStudentCourseDropdown.appendChild(option2);
                });
                
                console.log("Course dropdowns populated successfully");
            } catch (error) {
                console.error("Error populating course dropdowns:", error);
                showNotification('Error loading courses: ' + error.message, 'error');
                showConnectionStatus('Database error: ' + error.message, 'disconnected');
            }
        }
    </script>
</body>
</html>
